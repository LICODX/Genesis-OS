name: Build Genesis OS (Stable GRUB)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-iso:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-multilib nasm xorriso mtools grub-pc-bin grub-common

    - name: Compile Bootloader
      run: nasm -f elf32 boot.asm -o boot.o

    - name: Compile Kernel
      run: gcc -m32 -ffreestanding -O2 -Wall -Wextra -c kernel.c -o kernel.o

    - name: Link Kernel
      run: ld -m elf_i386 -T linker.ld -o genesis.bin boot.o kernel.o

    - name: Pack ISO
      run: |
        mkdir -p isodir/boot/grub
        cp genesis.bin isodir/boot/genesis.bin
        cat << 'EOF' > isodir/boot/grub/grub.cfg
        set timeout=0
        set default=0
        menuentry "Genesis OS GUI" {
            multiboot /boot/genesis.bin
            boot
        }
        EOF
        grub-mkrescue -o genesis_os.iso isodir

    - name: Upload ISO
      uses: actions/upload-artifact@v4
      with:
        name: genesis-os-stable
        path: genesis_os.iso        mkdir -p iso_root
        cat << 'EOF' > iso_root/limine.conf
        TIMEOUT=0
        VERBOSE=yes

        :Genesis OS GUI
            PROTOCOL=limine
            KERNEL_PATH=boot:///genesis.bin
        EOF

    - name: Pack ISO
      run: |
        # Pindahkan kernel ke dalam ISO
        cp genesis.bin iso_root/
        
        # Pindahkan file bootloader Limine
        cp limine/limine-bios.sys iso_root/
        cp limine/limine-bios-cd.bin iso_root/
        cp limine/limine-uefi-cd.bin iso_root/
        
        # Bungkus menjadi file .iso
        xorriso -as mkisofs -b limine-bios-cd.bin \
          -no-emul-boot -boot-load-size 4 -boot-info-table \
          --efi-boot limine-uefi-cd.bin \
          -efi-boot-part --efi-boot-image --protective-msdos-label \
          iso_root -o genesis_os.iso
          
        ./limine/limine bios-install genesis_os.iso

    - name: Upload ISO
      uses: actions/upload-artifact@v4
      with:
        name: genesis-os-release
        path: genesis_os.iso        VERBOSE=yes

        :Genesis OS GUI (Limbo Ready)
            PROTOCOL=limine
            KERNEL_PATH=boot:///genesis.bin
        EOF

    - name: Pack ISO
      run: |
        mkdir -p iso_root
        
        # Pindahkan kernel dan config ke dalam ISO
        cp genesis.bin iso_root/
        cp limine.cfg iso_root/
        
        # Pindahkan file bootloader
        cp limine/limine-bios.sys iso_root/
        cp limine/limine-bios-cd.bin iso_root/
        cp limine/limine-uefi-cd.bin iso_root/
        
        # Bungkus menjadi file .iso
        xorriso -as mkisofs -b limine-bios-cd.bin \
          -no-emul-boot -boot-load-size 4 -boot-info-table \
          --efi-boot limine-uefi-cd.bin \
          -efi-boot-part --efi-boot-image --protective-msdos-label \
          iso_root -o genesis_os.iso
          
        ./limine/limine bios-install genesis_os.iso

    - name: Upload ISO
      uses: actions/upload-artifact@v4
      with:
        name: genesis-os-release
        path: genesis_os.iso
